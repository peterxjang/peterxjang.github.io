<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Functional Canvas Approach With Redux: Part 2</title>
    <meta name="description" content="Examining low level, object oriented, and functional drawing techniques">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Peter Jang">
    <link rel="alternate" href="/feed/feed.json" type="application/json" title="Peter Jang">
  </head>
  <body>
    <header class="sticky">
      <h1 class="home"><a href="/">Peter Jang</a></h1>
      <ul class="nav">
      
        <li class="nav-item"><a href="/blog/">Blog</a></li>
        <li class="nav-item"><a href="https://www.linkedin.com/in/peterxjang/" target="_blank" rel="noopener" rel="noreferrer">LinkedIn</a></li>
        <li class="nav-item"><a href="https://twitter.com/peterxjang" target="_blank" rel="noopener" rel="noreferrer">Twitter</a></li>
      </ul>
    </header>

    <main class="tmpl-post">

      <div class="post-title">
  <h1>A Functional Canvas Approach With Redux: Part 2</h1>
  <time class="postlist-date" datetime="2017-07-27">27 Jul 2017</time>
</div>

<h4 id="using-the-three-fundamental-principles-of-redux">Using the three fundamental principles of Redux <a class="direct-link" href="#using-the-three-fundamental-principles-of-redux">#</a></h4>
<p><img src="/img/1__7Cb3rcSx__xZVbtNhQpLLMA.png" alt="Red and blue rectangles on an HTML canvas"></p>
<h2 id="translating-with-the-low-level-canvas-api">Translating With The Low Level Canvas API <a class="direct-link" href="#translating-with-the-low-level-canvas-api">#</a></h2>
<p>In <a href="a-functional-canvas-approach-with-redux-part-1.html">part 1</a>, we examined a low level, object oriented, and functional approach to drawing using HTML Canvas. Now let’s add some more interactivity to our drawing by responding to mouse events. To start with something basic, let’s translate the whole canvas by 5px each time the user clicks down on the mouse. Let’s see what this looks like using the low level Canvas API (live demo <a href="https://jsfiddle.net/peterxjang/cw8tow83">here</a>):</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"canvas"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">var</span> ctx <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">"2d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">"red"</span><span class="token punctuation">;</span><br>ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">"blue"</span><span class="token punctuation">;</span><br>ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">var</span> canvasX <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br>canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mousedown'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  canvasX <span class="token operator">+=</span> <span class="token number">5</span><span class="token punctuation">;</span><br>  ctx<span class="token punctuation">.</span><span class="token function">setTransform</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  ctx<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  ctx<span class="token punctuation">.</span><span class="token function">setTransform</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> canvasX<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">"red"</span><span class="token punctuation">;</span><br>  ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">"blue"</span><span class="token punctuation">;</span><br>  ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>In this example, we first draw a red and blue rectangle. Then we’re using the <code>canvasX</code> variable to keep track of the horizontal position of the canvas, and we’re adding an event listener to run some code any time the user clicks on the canvas. Each time the mouse is clicked, we add 5 to the <code>canvasX</code> variable.</p>
<p>There is no actual way to translate the objects on the canvas, since they aren’t objects, but simply pixels on the screen. To create the translate effect, we have to erase the canvas, then translate the canvas before drawing the items:</p>
<pre class="language-javascript"><code class="language-javascript">ctx<span class="token punctuation">.</span><span class="token function">setTransform</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>ctx<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span><br>ctx<span class="token punctuation">.</span><span class="token function">setTransform</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> canvasX<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>The setTransform function defines a mathematical matrix transformation with 6 arguments — scale x, skew x, skew y, scale y, translate x, and translate y. This may sound confusing, but it simply means you can control the scale, skew, and translation of the canvas using this function. The first line resets the canvas to the default (an x and y scale of 1, a skew of 0, and a translation to 0, 0). The second line clears the canvas. The third line moves the canvas over to the x position defined by <code>canvasX</code>. Any subsequent drawing commands will now be translated accordingly!</p>
<p>Note that the example code is not DRY, since we’re duplicating the drawing code each time we’re updating the canvas. Let’s move the drawing code into its own method called <code>draw</code>. Let’s also implement a more fully featured draggable canvas, where the canvas drags with the mouse while holding it down (live demo <a href="https://jsfiddle.net/peterxjang/ede0ompj">here</a>):</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"canvas"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">var</span> ctx <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">"2d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">var</span> canvasX <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> canvasY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br><span class="token keyword">var</span> xDragging <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> yDragging <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br><br><span class="token keyword">var</span> <span class="token function-variable function">draw</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  ctx<span class="token punctuation">.</span><span class="token function">setTransform</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  ctx<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  ctx<span class="token punctuation">.</span><span class="token function">setTransform</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> canvasX<span class="token punctuation">,</span> canvasY<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">"red"</span><span class="token punctuation">;</span><br>  ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">"blue"</span><span class="token punctuation">;</span><br>  ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mousedown'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  xDragging <span class="token operator">=</span> event<span class="token punctuation">.</span>offsetX<span class="token punctuation">;</span><br>  yDragging <span class="token operator">=</span> event<span class="token punctuation">.</span>offsetY<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mousemove'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>xDragging <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> yDragging <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    canvasX <span class="token operator">+=</span> event<span class="token punctuation">.</span>offsetX <span class="token operator">-</span> xDragging<span class="token punctuation">;</span><br>    canvasY <span class="token operator">+=</span> event<span class="token punctuation">.</span>offsetY <span class="token operator">-</span> yDragging<span class="token punctuation">;</span><br>    <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    xDragging <span class="token operator">=</span> event<span class="token punctuation">.</span>offsetX<span class="token punctuation">;</span><br>    yDragging <span class="token operator">=</span> event<span class="token punctuation">.</span>offsetY<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mouseup'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  xDragging <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br>  yDragging <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>The result looks like:</p>
<p><img src="/img/1__xOERmseqNFdIrfRVXN__YNg.gif" alt="Red and blue rectangles dragged together on an HTML canvas"></p>
<p>Here we’re using three event listeners. On <code>mousedown</code>, we store the user’s mouse position. On <code>mousemove</code>, we update the <code>canvasX</code> and <code>canvasY</code> variables based on the change in mouse position, redraw the canvas based on those updated values, and update the stored mouse position. On <code>mouseup</code>, we clear the stored mouse position (so we can determine whether or not the mouse is down).</p>
<p>At this point, the code isn’t too bad, but it’s easy to see that it can get out of hand — we are introducing more stray variables that can be mutated anywhere in the code. As we mentioned in the <a href="a-functional-canvas-approach-with-redux-part-1.html">introduction</a>, one way to organize the application state is to use an object oriented approach, which is what many Canvas libraries do. In our case, we’re going to look at a functional approach using Redux.</p>
<h2 id="translating-with-a-functional-redux-approach">Translating With A Functional Redux Approach <a class="direct-link" href="#translating-with-a-functional-redux-approach">#</a></h2>
<p>Instead of using object oriented principles, we can instead use functional principles with the Redux library. Instead of separating state into multiple instances of objects, we can keep the state in a single state object. We then can use pure functions to modify the state object. The Redux documentation refers to this design as <a href="https://redux.js.org/understanding/thinking-in-redux/three-principles">the three fundamental principles of Redux</a>, which we will implement in our canvas example one step at a time.</p>
<p>The first principle is <strong>Single source of truth</strong>, which in our case we can accomplish by defining all our application state in a single object. This is a pure data representation of what we will render to the screen. The goal here is to completely decouple this state data from the rest of the code.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span><br>  canvas<span class="token operator">:</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  items<span class="token operator">:</span> <span class="token punctuation">[</span><br>    <span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> width<span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> height<span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> color<span class="token operator">:</span> <span class="token string">"red"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span> width<span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> height<span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> color<span class="token operator">:</span> <span class="token string">"blue"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">]</span><span class="token punctuation">,</span><br>  xDragging<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br>  yDragging<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>The second principle is <strong>State is read-only</strong>, which we can accomplish by dispatching actions in the canvas <code>mousedown</code>, <code>mousemove</code>, and <code>mouseup</code> events. Any time the state needs to change, instead of mutating it directly, we send an action describing what happened. The action is simply a plain data object with a type to identify the action and any other data pertinent to that action. (Note we haven't defined the <code>store</code> variable yet - it's the part of Redux that enables you to dispatch actions, which we will define momentarily).</p>
<pre class="language-javascript"><code class="language-javascript">canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mousedown'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    type<span class="token operator">:</span> <span class="token string">'TRANSLATE_CANVAS_START'</span><span class="token punctuation">,</span><br>    xDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetX<span class="token punctuation">,</span><br>    yDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetY<br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mousemove'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> state <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>xDragging <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> state<span class="token punctuation">.</span>yDragging <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>      type<span class="token operator">:</span> <span class="token string">'TRANSLATE_CANVAS'</span><span class="token punctuation">,</span><br>      xDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetX<span class="token punctuation">,</span><br>      yDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetY<br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mouseup'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    type<span class="token operator">:</span> <span class="token string">'TRANSLATE_CANVAS_END'</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>The third principle is <strong>Changes are made with pure functions</strong>, which you can see in the reducer function. The reducer function gets called each time an action is dispatched. It is considered a “pure” function because it does not mutate any variables — instead of making changes directly to the given state, it returns a new copy of the state with appropriate modifications. The reducer function takes in the current state object and the action object, and outputs a new state object based on the action. Note that it returns the initialState defined earlier if no state is provided, which happens when it is first called up.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> <span class="token function-variable function">reducer</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> state <span class="token operator">===</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> initialState<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">case</span> <span class="token string">"TRANSLATE_CANVAS_START"</span><span class="token operator">:</span><br>      <span class="token keyword">return</span> <span class="token punctuation">{</span><br>        canvas<span class="token operator">:</span> state<span class="token punctuation">.</span>canvas<span class="token punctuation">,</span><br>        items<span class="token operator">:</span> state<span class="token punctuation">.</span>items<span class="token punctuation">,</span><br>        xDragging<span class="token operator">:</span> action<span class="token punctuation">.</span>xDragging<span class="token punctuation">,</span><br>        yDragging<span class="token operator">:</span> action<span class="token punctuation">.</span>yDragging<span class="token punctuation">,</span><br>      <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    <span class="token keyword">case</span> <span class="token string">"TRANSLATE_CANVAS"</span><span class="token operator">:</span><br>      <span class="token keyword">return</span> <span class="token punctuation">{</span><br>        canvas<span class="token operator">:</span> <span class="token punctuation">{</span><br>          x<span class="token operator">:</span> state<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>x <span class="token operator">+</span> action<span class="token punctuation">.</span>xDragging <span class="token operator">-</span> state<span class="token punctuation">.</span>xDragging<span class="token punctuation">,</span><br>          y<span class="token operator">:</span> state<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>y <span class="token operator">+</span> action<span class="token punctuation">.</span>yDragging <span class="token operator">-</span> state<span class="token punctuation">.</span>yDragging<span class="token punctuation">,</span><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        items<span class="token operator">:</span> state<span class="token punctuation">.</span>items<span class="token punctuation">,</span><br>        xDragging<span class="token operator">:</span> action<span class="token punctuation">.</span>xDragging<span class="token punctuation">,</span><br>        yDragging<span class="token operator">:</span> action<span class="token punctuation">.</span>yDragging<span class="token punctuation">,</span><br>      <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    <span class="token keyword">case</span> <span class="token string">"TRANSLATE_CANVAS_END"</span><span class="token operator">:</span><br>      <span class="token keyword">return</span> <span class="token punctuation">{</span><br>        canvas<span class="token operator">:</span> state<span class="token punctuation">.</span>canvas<span class="token punctuation">,</span><br>        items<span class="token operator">:</span> state<span class="token punctuation">.</span>items<span class="token punctuation">,</span><br>        xDragging<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br>        yDragging<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br>      <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    <span class="token keyword">default</span><span class="token operator">:</span><br>      <span class="token keyword">return</span> state<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>All that’s left is to wire everything up together, which is done with the code below. The <code>createStore</code> function creates the Redux store using the <code>reducer</code> function we defined. The <code>subscribe</code> function tells Redux to call up the given <code>draw</code> function each time the store changes due to some action.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> store <span class="token operator">=</span> Redux<span class="token punctuation">.</span><span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span><span class="token punctuation">;</span><br>store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>draw<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>The <code>draw</code> function is similar to the one we had before. The <code>draw</code> function gets the current Redux state and renders the desired output to the screen. Note that this is the only part of our code which refers to the <code>ctx</code> canvas rendering context. The rendering code has been completely isolated into this draw function. Every other line of code is only responsible for managing the state data and how it transforms. This separation of concerns is the key to making the code easier to maintain.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"canvas"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">var</span> ctx <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">"2d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">var</span> <span class="token function-variable function">draw</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> state <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  ctx<span class="token punctuation">.</span><span class="token function">setTransform</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  ctx<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  ctx<span class="token punctuation">.</span><span class="token function">setTransform</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>x<span class="token punctuation">,</span> state<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  state<span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> item<span class="token punctuation">.</span>color<span class="token punctuation">;</span><br>    ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>x<span class="token punctuation">,</span> item<span class="token punctuation">.</span>y<span class="token punctuation">,</span> item<span class="token punctuation">.</span>width<span class="token punctuation">,</span> item<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>You can check out the complete Redux implementation with a live demo <a href="https://jsfiddle.net/peterxjang/yvypt2w6">here</a>.</p>
<p>Let’s walk through an example of how Redux responds to an action. Say the app first starts up, so the state is equal to the initialState variable. If the user clicks on the canvas at the position (10, 30), the following code gets triggered:</p>
<pre class="language-javascript"><code class="language-javascript">canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mousedown'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    type<span class="token operator">:</span> <span class="token string">'TRANSLATE_CANVAS_START'</span><span class="token punctuation">,</span><br>    xDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetX<span class="token punctuation">,</span><br>    yDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetY<br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>The store.dispatch function triggers the reducer function to be called up with the following arguments:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> <span class="token function-variable function">reducer</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// state => initialState</span><br>  <span class="token comment">// action => { type: 'TRANSLATE_CANVAS_START', xDragging: 10, yDragging: 30 }</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>Walking through the reducer function code, you’ll hit the 'TRANSLATE_CANVAS_START' case and return the following state:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">return</span> <span class="token punctuation">{</span><br>  canvas<span class="token operator">:</span> state<span class="token punctuation">.</span>canvas<span class="token punctuation">,</span><br>  items<span class="token operator">:</span> state<span class="token punctuation">.</span>items<span class="token punctuation">,</span><br>  xDragging<span class="token operator">:</span> action<span class="token punctuation">.</span>xDragging<span class="token punctuation">,</span><br>  yDragging<span class="token operator">:</span> action<span class="token punctuation">.</span>yDragging<span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>This is a copy of the original state with updated xDragging and yDragging values using the values given by the action object. Once the reducer returns this state, the Redux state is updated, which in turn triggers the draw function and updates the view. As the user drags the mouse, additional actions will be dispatched, triggering the reducer and draw functions accordingly.</p>
<h2 id="adding-features-with-redux">Adding Features With Redux <a class="direct-link" href="#adding-features-with-redux">#</a></h2>
<p>Redux may be more difficult to wire together and understand initially, but this clear separation of data and rendering code makes it easier to add new features over time. Note that the code no longer has stray variables that can be mutated anywhere — all the relevant data is stored in the Redux state, and the only way it can be changed is by dispatching a Redux action. Let’s add another feature to our Redux example — translating individual items. The final result will look like:</p>
<p><img src="/img/1__3KL872omMJcQhloXLjq__tg.gif" alt="Red and blue rectangles dragged separately on an HTML canvas"></p>
<p>Let’s take a look at the changes needed to make this feature work. First, the shape of the state changed to include ids for each item, which we use to keep track of which item is being dragged with <code>draggingItemId</code>. Initially no item is being dragged, so <code>draggingItemId</code> is set to null.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="highlight-line"><span class="token keyword">var</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  canvas<span class="token operator">:</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  items<span class="token operator">:</span> <span class="token punctuation">[</span></span><br><mark class="highlight-line highlight-line-active">    <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> x<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> width<span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> height<span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> color<span class="token operator">:</span> <span class="token string">"red"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> x<span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span> width<span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> height<span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> color<span class="token operator">:</span> <span class="token string">"blue"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></mark><br><span class="highlight-line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  xDragging<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  yDragging<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span><br><mark class="highlight-line highlight-line-active">  draggingItemId<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span></mark><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span></code></pre>
<p>Now in our reducer function, we have 3 new actions — <code>TRANSLATE_ITEM_START</code>, <code>TRANSLATE_ITEM</code>, and <code>TRANSLATE_ITEM_END</code>. For <code>TRANSLATE_ITEM_START</code>, we are returning a copy of the state with the updated mouse position as well as which item was selected. Note that the reducer isn’t responsible for determining which item was selected — that code is defined elsewhere. The reducer is only responsible for creating a copy of the state with updated values.</p>
<pre class="language-javascript"><code class="language-javascript">    <span class="token keyword">case</span> <span class="token string">'TRANSLATE_ITEM_START'</span><span class="token operator">:</span><br>      <span class="token keyword">return</span> <span class="token punctuation">{</span><br>        canvas<span class="token operator">:</span> state<span class="token punctuation">.</span>canvas<span class="token punctuation">,</span><br>        items<span class="token operator">:</span> state<span class="token punctuation">.</span>items<span class="token punctuation">,</span><br>        xDragging<span class="token operator">:</span> action<span class="token punctuation">.</span>xDragging<span class="token punctuation">,</span><br>        yDragging<span class="token operator">:</span> action<span class="token punctuation">.</span>yDragging<span class="token punctuation">,</span><br>        draggingItemId<span class="token operator">:</span> action<span class="token punctuation">.</span>id<br>      <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>For <code>TRANSLATE_ITEM</code>, we are updating the x and y values of the item currently being dragged. Note that we’re taking great care not to mutate the state, but rather to return a brand new copy of every part of the state. There are ways to simplify this code, but for now we’ll leave it as explicit as possible. To update the item’s x and y values without mutation, we create a new copy of the items called <code>newItems</code> using JavaScript’s map array function. Once we create the <code>newItems</code>, we return the copy of the state, which has updated <code>items</code>, <code>xDragging</code>, and <code>yDragging</code> values.</p>
<pre class="language-javascript"><code class="language-javascript">    <span class="token keyword">case</span> <span class="token string">'TRANSLATE_ITEM'</span><span class="token operator">:</span><br>      <span class="token keyword">var</span> newItems <span class="token operator">=</span> state<span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>id <span class="token operator">===</span> state<span class="token punctuation">.</span>draggingItemId<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          <span class="token keyword">return</span> <span class="token punctuation">{</span><br>            id<span class="token operator">:</span> item<span class="token punctuation">.</span>id<span class="token punctuation">,</span><br>            x<span class="token operator">:</span> item<span class="token punctuation">.</span>x <span class="token operator">+</span> action<span class="token punctuation">.</span>xDragging <span class="token operator">-</span> state<span class="token punctuation">.</span>xDragging<span class="token punctuation">,</span><br>            y<span class="token operator">:</span> item<span class="token punctuation">.</span>y <span class="token operator">+</span> action<span class="token punctuation">.</span>yDragging <span class="token operator">-</span> state<span class="token punctuation">.</span>yDragging<span class="token punctuation">,</span><br>            width<span class="token operator">:</span> item<span class="token punctuation">.</span>width<span class="token punctuation">,</span><br>            height<span class="token operator">:</span> item<span class="token punctuation">.</span>height<span class="token punctuation">,</span><br>            color<span class="token operator">:</span> item<span class="token punctuation">.</span>color<br>          <span class="token punctuation">}</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>          <span class="token keyword">return</span> item<span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>For <code>TRANSLATE_ITEM_END</code>, we are returning a copy of the state with the mouse position and the selected item id set to null.</p>
<pre class="language-javascript"><code class="language-javascript">    <span class="token keyword">case</span> <span class="token string">'TRANSLATE_ITEM_END'</span><span class="token operator">:</span><br>      <span class="token keyword">return</span> <span class="token punctuation">{</span><br>        canvas<span class="token operator">:</span> state<span class="token punctuation">.</span>canvas<span class="token punctuation">,</span><br>        items<span class="token operator">:</span> state<span class="token punctuation">.</span>items<span class="token punctuation">,</span><br>        xDragging<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br>        yDragging<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br>        draggingItemId<span class="token operator">:</span> <span class="token keyword">null</span><br>      <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>Finally, we have our modified event listener code which determines whether the canvas or an individual item is being dragged. On <code>mousedown</code>, we loop through the items in reverse order to see if an item is clicked on. To do this we can use the <code>isPointInPath</code> function that is part of the Canvas context. This function works by first drawing a virtual path (with the <code>beginPath</code> and <code>rect</code> functions). Once a path is drawn, the <code>isPointInPath</code> function can be called with an x and y coordinate, and will return true if the point is in the path. If it is, we dispatch a <code>TRANSLATE_ITEM_START</code> action. If not, we dispatch a <code>TRANSLATE_CANVAS_START</code> action.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="highlight-line">canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mousedown'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><mark class="highlight-line highlight-line-active">  <span class="token keyword">var</span> state <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> state<span class="token punctuation">.</span>items<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token keyword">var</span> item <span class="token operator">=</span> state<span class="token punctuation">.</span>items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">    ctx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">    ctx<span class="token punctuation">.</span><span class="token function">rect</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>x<span class="token punctuation">,</span> item<span class="token punctuation">.</span>y<span class="token punctuation">,</span> item<span class="token punctuation">.</span>width<span class="token punctuation">,</span> item<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">isPointInPath</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>offsetX<span class="token punctuation">,</span> event<span class="token punctuation">.</span>offsetY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">      store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">        type<span class="token operator">:</span> <span class="token string">'TRANSLATE_ITEM_START'</span><span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">        id<span class="token operator">:</span> item<span class="token punctuation">.</span>id<span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">        xDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetX<span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">        yDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetY</mark><br><mark class="highlight-line highlight-line-active">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">      <span class="token keyword">return</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token punctuation">}</span></mark><br><mark class="highlight-line highlight-line-active">  <span class="token punctuation">}</span></mark><br><span class="highlight-line">  store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><br><span class="highlight-line">    type<span class="token operator">:</span> <span class="token string">'TRANSLATE_CANVAS_START'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    xDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetX<span class="token punctuation">,</span></span><br><span class="highlight-line">    yDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetY</span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>On <code>mousemove</code>, we can examine the state to see if an item is currently being dragged (using the <code>draggingItemId</code> value) or if the canvas is currently being dragged (using the <code>xDragging</code> and <code>yDragging</code> values). If something is being dragged, we dispatch the <code>TRANSLATE_ITEM</code> or <code>TRANSLATE_CANVAS</code> action accordingly.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="highlight-line">canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mousemove'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">var</span> state <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><mark class="highlight-line highlight-line-active">  <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>draggingItemId <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">    store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">      type<span class="token operator">:</span> <span class="token string">'TRANSLATE_ITEM'</span><span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">      xDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetX<span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">      yDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetY</mark><br><mark class="highlight-line highlight-line-active">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><span class="highlight-line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>xDragging <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> state<span class="token punctuation">.</span>yDragging <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><br><span class="highlight-line">      type<span class="token operator">:</span> <span class="token string">'TRANSLATE_CANVAS'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      xDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetX<span class="token punctuation">,</span></span><br><span class="highlight-line">      yDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetY</span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>On mouseup, we dispatch a <code>TRANSLATE_ITEM_END</code> or <code>TRANSLATE_CANVAS_END</code> action depending on which was being dragged. Note that these could be combined into a single <code>TRANSLATE_END</code> action since they’re so similar, but we’ll keep them separate for the sake of clarity for now.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="highlight-line">canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mouseup'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">var</span> state <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><mark class="highlight-line highlight-line-active">  <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>draggingItemId <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">    store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">      type<span class="token operator">:</span> <span class="token string">'TRANSLATE_ITEM_END'</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></mark><br><span class="highlight-line">    store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><br><span class="highlight-line">      type<span class="token operator">:</span> <span class="token string">'TRANSLATE_CANVAS_END'</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><mark class="highlight-line highlight-line-active">  <span class="token punctuation">}</span></mark><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>You can check out the complete live demo <a href="https://jsfiddle.net/peterxjang/woufx97b">here</a>.</p>
<p>Although adding new features with Redux may seem awkward at first, it is very worthwhile because forces you to maintain a separation of concerns. Once you get used to it, it becomes easy to add new features — since everything has an appropriate place, there’s fewer decisions that need to be made from a code design perspective. Although JavaScript is not a purely functional language, we can use functional approaches with Redux to avoiding mutation, which makes the code easier to maintain.</p>


<hr>
<ul class="post-navigation"><li>Next: <a href="/blog/sending-post-requests-in-rails-51-without-jquery.html">Sending POST requests in Rails 5.1 without jQuery</a></li><li>Previous: <a href="/blog/a-functional-canvas-approach-with-redux-part-1.html">A Functional Canvas Approach With Redux: Part 1</a></li>
  <li>Back to <a href="/blog/">all posts</a></li>
</ul>

    </main>

    <footer></footer>

    <!-- Current page: /blog/a-functional-canvas-approach-with-redux-part-2.html -->
  </body>
</html>
