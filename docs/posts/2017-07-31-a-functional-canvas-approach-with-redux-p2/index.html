<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Functional Canvas Approach With Redux: Part 2</title>
    <meta name="description" content="Examining low level, object oriented, and functional drawing techniques">
    <link rel="stylesheet" href="/blog/css/index.css">
    <link rel="stylesheet" href="/blog/css/prism-base16-monokai.dark.css">
    <link rel="alternate" href="/blog/feed/feed.xml" type="application/atom+xml" title="Peter Jang">
    <link rel="alternate" href="/blog/feed/feed.json" type="application/json" title="Peter Jang">
  </head>
  <body>
    <header>
      <h1 class="home"><a href="/">Peter Jang</a></h1>
      <ul class="nav">
        <li class="nav-item"><a href="/blog/">Blog</a></li>
        <li class="nav-item"><a href="/blog/posts/">Archive</a></li>
        <li class="nav-item"><a href="/blog/about/">About</a></li>
      </ul>
    </header>

    <main class="tmpl-post">

      <h1>A Functional Canvas Approach With Redux: Part 2</h1>

<h4 id="using-the-three-fundamental-principles-of-redux">Using the three fundamental principles of Redux <a class="direct-link" href="#using-the-three-fundamental-principles-of-redux">#</a></h4>
<p><img src="https://cdn-images-1.medium.com/max/2000/1*7Cb3rcSx_xZVbtNhQpLLMA.png" alt=""></p>
<h2 id="translating-with-the-low-level-canvas-api">Translating With The Low Level Canvas API <a class="direct-link" href="#translating-with-the-low-level-canvas-api">#</a></h2>
<p>In <a href="https://medium.com/@peterxjang/a-functional-canvas-approach-with-redux-ce59a369241b">part 1</a>, we examined a low level, object oriented, and functional approach to drawing using HTML Canvas. Now let’s add some more interactivity to our drawing by responding to mouse events. To start with something basic, let’s translate the whole canvas by 5px each time the user clicks down on the mouse. Let’s see what this looks like using the low level Canvas API:</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://medium.com/media/83947ffeb5c1689df5a4bac208de9ca8<span class="token punctuation">"</span></span> <span class="token attr-name">frameborder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span></code></pre>
<p>In this example, we first draw a red and blue rectangle. Then we’re using the canvasX variable to keep track of the horizontal position of the canvas, and we’re adding an event listener to run some code any time the user clicks on the canvas. Each time the mouse is clicked, we add 5 to the canvasX variable.</p>
<p>There is no actual way to translate the objects on the canvas, since they aren’t objects, but simply pixels on the screen. To create the translate effect, we have to erase the canvas, then translate the canvas before drawing the items:</p>
<pre class="language-javascript"><code class="language-javascript">ctx<span class="token punctuation">.</span><span class="token function">setTransform</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>ctx<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span><br>ctx<span class="token punctuation">.</span><span class="token function">setTransform</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> canvasX<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>The setTransform function defines a mathematical matrix transformation with 6 arguments — scale x, skew x, skew y, scale y, translate x, and translate y. This may sound confusing, but it simply means you can control the scale, skew, and translation of the canvas using this function. The first line resets the canvas to the default (an x and y scale of 1, a skew of 0, and a translation to 0, 0). The second line clears the canvas. The third line moves the canvas over to the x position defined by canvasX. Any subsequent drawing commands will now be translated accordingly!</p>
<p>Note that the example code is not DRY, since we’re duplicating the drawing code each time we’re updating the canvas. Let’s move the drawing code into its own method called draw. Let’s also implement a more fully featured draggable canvas, where the canvas drags with the mouse while holding it down:</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://medium.com/media/236c6b3db80e89284abec01abce17b53<span class="token punctuation">"</span></span> <span class="token attr-name">frameborder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span></code></pre>
<p>The result looks like:</p>
<p><img src="https://cdn-images-1.medium.com/max/2000/1*xOERmseqNFdIrfRVXN-YNg.gif" alt=""></p>
<p>Here we’re using three event listeners. On mousedown, we store the user’s mouse position. On mousemove, we update the canvasX and canvasY variables based on the change in mouse position, redraw the canvas based on those updated values, and update the stored mouse position. On mouseup, we clear the stored mouse position (so we can determine whether or not the mouse is down).</p>
<p>At this point, the code isn’t too bad, but it’s easy to see that it can get out of hand — we are introducing more stray variables that can be mutated anywhere in the code. As we mentioned in the <a href="https://medium.com/@peterxjang/a-functional-canvas-approach-with-redux-ce59a369241b">introduction</a>, one way to organize the application state is to use an object oriented approach, which is what many Canvas libraries do. In our case, we’re going to look at a functional approach using Redux.</p>
<h2 id="translating-with-a-functional-redux-approach">Translating With A Functional Redux Approach <a class="direct-link" href="#translating-with-a-functional-redux-approach">#</a></h2>
<p>Instead of using object oriented principles, we can instead use functional principles with the Redux library. Instead of separating state into multiple instances of objects, we can keep the state in a single state object. We then can use pure functions to modify the state object. Here is the implementation of the above code using Redux (which we’ll break down step by step):</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://medium.com/media/045743f152c802b095f0340b8c62f93f<span class="token punctuation">"</span></span> <span class="token attr-name">frameborder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span></code></pre>
<p>Let’s examine this code using the three fundamental principles of Redux. The first principle is <strong>Single source of truth</strong>, which you can see from the initialState variable:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span><br>  canvas<span class="token operator">:</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  items<span class="token operator">:</span> <span class="token punctuation">[</span><br>    <span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> width<span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> height<span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> color<span class="token operator">:</span> <span class="token string">"red"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span> width<span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> height<span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> color<span class="token operator">:</span> <span class="token string">"blue"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">]</span><span class="token punctuation">,</span><br>  xDragging<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br>  yDragging<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>This is a pure data representation of what we will render to the screen. The goal here is to completely decouple this state data from the rest of the code. The second principle is <strong>State is read only</strong>, which you can see from the actions dispatched in the event listeners:</p>
<pre class="language-javascript"><code class="language-javascript">canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><br>  <span class="token string">"mousedown"</span><span class="token punctuation">,</span><br>  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>      type<span class="token operator">:</span> <span class="token string">"TRANSLATE_CANVAS_START"</span><span class="token punctuation">,</span><br>      xDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetX<span class="token punctuation">,</span><br>      yDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetY<span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token boolean">false</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><br>  <span class="token string">"mousemove"</span><span class="token punctuation">,</span><br>  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> state <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>xDragging <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> state<span class="token punctuation">.</span>yDragging <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>        type<span class="token operator">:</span> <span class="token string">"TRANSLATE_CANVAS"</span><span class="token punctuation">,</span><br>        xDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetX<span class="token punctuation">,</span><br>        yDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetY<span class="token punctuation">,</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token boolean">false</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><br>  <span class="token string">"mouseup"</span><span class="token punctuation">,</span><br>  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>      type<span class="token operator">:</span> <span class="token string">"TRANSLATE_CANVAS_END"</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token boolean">false</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Any time the state needs to change, instead of mutating it directly, we send an action describing what happened. The action is simply a plain data object with a type to identify the action and any other data pertinent to that action. The third principle is <strong>Changes are made with pure functions</strong>, which you can see in the reducer function:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> <span class="token function-variable function">reducer</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> state <span class="token operator">===</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> initialState<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">case</span> <span class="token string">"TRANSLATE_CANVAS_START"</span><span class="token operator">:</span><br>      <span class="token keyword">return</span> <span class="token punctuation">{</span><br>        canvas<span class="token operator">:</span> state<span class="token punctuation">.</span>canvas<span class="token punctuation">,</span><br>        items<span class="token operator">:</span> state<span class="token punctuation">.</span>items<span class="token punctuation">,</span><br>        xDragging<span class="token operator">:</span> action<span class="token punctuation">.</span>xDragging<span class="token punctuation">,</span><br>        yDragging<span class="token operator">:</span> action<span class="token punctuation">.</span>yDragging<span class="token punctuation">,</span><br>      <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    <span class="token keyword">case</span> <span class="token string">"TRANSLATE_CANVAS"</span><span class="token operator">:</span><br>      <span class="token keyword">return</span> <span class="token punctuation">{</span><br>        canvas<span class="token operator">:</span> <span class="token punctuation">{</span><br>          x<span class="token operator">:</span> state<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>x <span class="token operator">+</span> action<span class="token punctuation">.</span>xDragging <span class="token operator">-</span> state<span class="token punctuation">.</span>xDragging<span class="token punctuation">,</span><br>          y<span class="token operator">:</span> state<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>y <span class="token operator">+</span> action<span class="token punctuation">.</span>yDragging <span class="token operator">-</span> state<span class="token punctuation">.</span>yDragging<span class="token punctuation">,</span><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        items<span class="token operator">:</span> state<span class="token punctuation">.</span>items<span class="token punctuation">,</span><br>        xDragging<span class="token operator">:</span> action<span class="token punctuation">.</span>xDragging<span class="token punctuation">,</span><br>        yDragging<span class="token operator">:</span> action<span class="token punctuation">.</span>yDragging<span class="token punctuation">,</span><br>      <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    <span class="token keyword">case</span> <span class="token string">"TRANSLATE_CANVAS_END"</span><span class="token operator">:</span><br>      <span class="token keyword">return</span> <span class="token punctuation">{</span><br>        canvas<span class="token operator">:</span> state<span class="token punctuation">.</span>canvas<span class="token punctuation">,</span><br>        items<span class="token operator">:</span> state<span class="token punctuation">.</span>items<span class="token punctuation">,</span><br>        xDragging<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br>        yDragging<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br>      <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    <span class="token keyword">default</span><span class="token operator">:</span><br>      <span class="token keyword">return</span> state<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>The reducer function gets called each time an action is dispatched. It is considered a “pure” function because it does not mutate any variables — instead of making changes directly to the given state, it returns a new copy of the state with appropriate modifications. The reducer function takes in the current state object and the action object, and outputs a new state object based on the action. Note that it returns the initialState defined earlier if no state is provided, which happens when it is first called up.</p>
<p>All that’s left is to wire everything up together, which is done with this code:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> store <span class="token operator">=</span> Redux<span class="token punctuation">.</span><span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span><span class="token punctuation">;</span><br>store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>draw<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>The createStore function creates the Redux store using the reducer function we defined. The subscribe function tells Redux to call up the given draw function each time the store changes due to some action. The draw function is similar to the one we had before:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> <span class="token function-variable function">draw</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> state <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  ctx<span class="token punctuation">.</span><span class="token function">setTransform</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  ctx<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  ctx<span class="token punctuation">.</span><span class="token function">setTransform</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>x<span class="token punctuation">,</span> state<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  state<span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> item<span class="token punctuation">.</span>color<span class="token punctuation">;</span><br>    ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>x<span class="token punctuation">,</span> item<span class="token punctuation">.</span>y<span class="token punctuation">,</span> item<span class="token punctuation">.</span>width<span class="token punctuation">,</span> item<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>The draw function gets the current Redux state and renders the desired output to the screen. Note that this is the only part of our code which refers to the ctx canvas rendering context. The rendering code has been completely isolated into this draw function. Every other line of code is only responsible for managing the state data and how it transforms. This separation of concerns is the key to making the code easier to maintain.</p>
<p>Let’s walk through an example of how Redux responds to an action. Say the app first starts up, so the state is equal to the initialState variable. If the user clicks on the canvas at the position (10, 30), the following code gets triggered:</p>
<pre class="language-javascript"><code class="language-javascript">canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><br>  <span class="token string">"mousedown"</span><span class="token punctuation">,</span><br>  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>      type<span class="token operator">:</span> <span class="token string">"TRANSLATE_CANVAS_START"</span><span class="token punctuation">,</span><br>      xDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetX<span class="token punctuation">,</span><br>      yDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetY<span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token boolean">false</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>The store.dispatch function triggers the reducer function to be called up with the following arguments:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> <span class="token function-variable function">reducer</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// state => initialState</span><br>  <span class="token comment">// action => { type: 'TRANSLATE_CANVAS_START', xDragging: 10, yDragging: 30 }</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>Walking through the reducer function code, you’ll hit the 'TRANSLATE_CANVAS_START' case and return the following state:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">return</span> <span class="token punctuation">{</span><br>  canvas<span class="token operator">:</span> state<span class="token punctuation">.</span>canvas<span class="token punctuation">,</span><br>  items<span class="token operator">:</span> state<span class="token punctuation">.</span>items<span class="token punctuation">,</span><br>  xDragging<span class="token operator">:</span> action<span class="token punctuation">.</span>xDragging<span class="token punctuation">,</span><br>  yDragging<span class="token operator">:</span> action<span class="token punctuation">.</span>yDragging<span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>This is a copy of the original state with updated xDragging and yDragging values using the values given by the action object. Once the reducer returns this state, the Redux state is updated, which in turn triggers the draw function and updates the view. As the user drags the mouse, additional actions will be dispatched, triggering the reducer and draw functions accordingly.</p>
<h2 id="adding-features-with-redux">Adding Features With Redux <a class="direct-link" href="#adding-features-with-redux">#</a></h2>
<p>Redux may be more difficult to wire together and understand initially, but this clear separation of data and rendering code makes it easier to add new features over time. Note that the code no longer has stray variables that can be mutated anywhere — all the relevant data is stored in the Redux state, and the only way it can be changed is by dispatching a Redux action. Let’s add another feature to our Redux example — translating individual items.</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://medium.com/media/c4f36ae1bea5caf2dc3ffc28d84f7d98<span class="token punctuation">"</span></span> <span class="token attr-name">frameborder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span></code></pre>
<p>The result looks like:</p>
<p><img src="https://cdn-images-1.medium.com/max/2000/1*3KL872omMJcQhloXLjq_tg.gif" alt=""></p>
<p>Let’s take a look at the changes needed to make this feature work. First, the shape of the state changed to include ids for each item, which we use to keep track of which item is being dragged with draggingItemId:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span><br>  canvas<span class="token operator">:</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  items<span class="token operator">:</span> <span class="token punctuation">[</span><br>    <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> x<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> width<span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> height<span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> color<span class="token operator">:</span> <span class="token string">"red"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> x<span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span> width<span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> height<span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> color<span class="token operator">:</span> <span class="token string">"blue"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">]</span><span class="token punctuation">,</span><br>  xDragging<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br>  yDragging<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br>  draggingItemId<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>Initially no item is being dragged, so draggingItemId is set to null. Now in our reducer function, we have 3 new actions — 'TRANSLATE_ITEM_START', 'TRANSLATE_ITEM', and 'TRANSLATE_ITEM_END'.</p>
<pre class="language-javascript"><code class="language-javascript">    <span class="token keyword">case</span> <span class="token string">'TRANSLATE_ITEM_START'</span><span class="token operator">:</span><br>      <span class="token keyword">return</span> <span class="token punctuation">{</span><br>        canvas<span class="token operator">:</span> state<span class="token punctuation">.</span>canvas<span class="token punctuation">,</span><br>        items<span class="token operator">:</span> state<span class="token punctuation">.</span>items<span class="token punctuation">,</span><br>        xDragging<span class="token operator">:</span> action<span class="token punctuation">.</span>xDragging<span class="token punctuation">,</span><br>        yDragging<span class="token operator">:</span> action<span class="token punctuation">.</span>yDragging<span class="token punctuation">,</span><br>        draggingItemId<span class="token operator">:</span> action<span class="token punctuation">.</span>id<br>      <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>For 'TRANSLATE_ITEM_START', we are returning a copy of the state with the updated mouse position as well as which item was selected. Note that the reducer isn’t responsible for determining which item was selected — that code is defined elsewhere. The reducer is only responsible for creating a copy of the state with updated values.</p>
<pre class="language-javascript"><code class="language-javascript">    <span class="token keyword">case</span> <span class="token string">'TRANSLATE_ITEM'</span><span class="token operator">:</span><br>      <span class="token keyword">var</span> newItems <span class="token operator">=</span> state<span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>id <span class="token operator">===</span> state<span class="token punctuation">.</span>draggingItemId<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          <span class="token keyword">return</span> <span class="token punctuation">{</span><br>            id<span class="token operator">:</span> item<span class="token punctuation">.</span>id<span class="token punctuation">,</span><br>            x<span class="token operator">:</span> item<span class="token punctuation">.</span>x <span class="token operator">+</span> action<span class="token punctuation">.</span>xDragging <span class="token operator">-</span> state<span class="token punctuation">.</span>xDragging<span class="token punctuation">,</span><br>            y<span class="token operator">:</span> item<span class="token punctuation">.</span>y <span class="token operator">+</span> action<span class="token punctuation">.</span>yDragging <span class="token operator">-</span> state<span class="token punctuation">.</span>yDragging<span class="token punctuation">,</span><br>            width<span class="token operator">:</span> item<span class="token punctuation">.</span>width<span class="token punctuation">,</span><br>            height<span class="token operator">:</span> item<span class="token punctuation">.</span>height<span class="token punctuation">,</span><br>            color<span class="token operator">:</span> item<span class="token punctuation">.</span>color<br>          <span class="token punctuation">}</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>          <span class="token keyword">return</span> item<span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>For 'TRANSLATE_ITEM', we are updating the x and y values of the item currently being dragged. Note that we’re taking great care not to mutate the state, but rather to return a brand new copy of every part of the state. There are ways to simplify this code, but for now we’ll leave it as explicit as possible. To update the item’s x and y values without mutation, we create a new copy of the items called newItems using JavaScript’s map array function. Once we create the newItems, we return the copy of the state, which has updated items, xDragging, and yDragging values.</p>
<pre class="language-javascript"><code class="language-javascript">    <span class="token keyword">case</span> <span class="token string">'TRANSLATE_ITEM_END'</span><span class="token operator">:</span><br>      <span class="token keyword">return</span> <span class="token punctuation">{</span><br>        canvas<span class="token operator">:</span> state<span class="token punctuation">.</span>canvas<span class="token punctuation">,</span><br>        items<span class="token operator">:</span> state<span class="token punctuation">.</span>items<span class="token punctuation">,</span><br>        xDragging<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br>        yDragging<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br>        draggingItemId<span class="token operator">:</span> <span class="token keyword">null</span><br>      <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>For 'TRANSLATE_ITEM_END', we are returning a copy of the state with the mouse position and the selected item id set to null.</p>
<p>Finally, we have our modified event listener code which determines whether the canvas or an individual item is being dragged:</p>
<pre class="language-javascript"><code class="language-javascript">canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><br>  <span class="token string">"mousedown"</span><span class="token punctuation">,</span><br>  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> state <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> state<span class="token punctuation">.</span>items<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">var</span> item <span class="token operator">=</span> state<span class="token punctuation">.</span>items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><br>      ctx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      ctx<span class="token punctuation">.</span><span class="token function">rect</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>x<span class="token punctuation">,</span> item<span class="token punctuation">.</span>y<span class="token punctuation">,</span> item<span class="token punctuation">.</span>width<span class="token punctuation">,</span> item<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">isPointInPath</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>offsetX<span class="token punctuation">,</span> event<span class="token punctuation">.</span>offsetY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>          type<span class="token operator">:</span> <span class="token string">"TRANSLATE_ITEM_START"</span><span class="token punctuation">,</span><br>          id<span class="token operator">:</span> item<span class="token punctuation">.</span>id<span class="token punctuation">,</span><br>          xDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetX<span class="token punctuation">,</span><br>          yDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetY<span class="token punctuation">,</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">return</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>    store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>      type<span class="token operator">:</span> <span class="token string">"TRANSLATE_CANVAS_START"</span><span class="token punctuation">,</span><br>      xDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetX<span class="token punctuation">,</span><br>      yDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetY<span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token boolean">false</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>On mousedown, we loop through the items in reverse order to see if an item is clicked on. To do this we can use the isPointInPath function that is part of the Canvas context. This function works by first drawing a virtual path (with the beginPath and rect functions). Once a path is drawn, the isPointInPath function can be called with an x and y coordinate, and will return true if the point is in the path. If it is, we dispatch a 'TRANSLATE_ITEM_START' action. If not, we dispatch a 'TRANSLATE_CANVAS_START' action.</p>
<pre class="language-javascript"><code class="language-javascript">canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><br>  <span class="token string">"mousemove"</span><span class="token punctuation">,</span><br>  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> state <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>draggingItemId <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>        type<span class="token operator">:</span> <span class="token string">"TRANSLATE_ITEM"</span><span class="token punctuation">,</span><br>        xDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetX<span class="token punctuation">,</span><br>        yDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetY<span class="token punctuation">,</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>xDragging <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> state<span class="token punctuation">.</span>yDragging <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>        type<span class="token operator">:</span> <span class="token string">"TRANSLATE_CANVAS"</span><span class="token punctuation">,</span><br>        xDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetX<span class="token punctuation">,</span><br>        yDragging<span class="token operator">:</span> event<span class="token punctuation">.</span>offsetY<span class="token punctuation">,</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token boolean">false</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>On mousemove, we can examine the state to see if an item is currently being dragged (using the draggingItemId value) or if the canvas is currently being dragged (using the xDragging and yDragging values). If something is being dragged, we dispatch the 'TRANSLATE_ITEM' or 'TRANSLATE_CANVAS' action accordingly.</p>
<pre class="language-javascript"><code class="language-javascript">canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><br>  <span class="token string">"mouseup"</span><span class="token punctuation">,</span><br>  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> state <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>draggingItemId <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>        type<span class="token operator">:</span> <span class="token string">"TRANSLATE_ITEM_END"</span><span class="token punctuation">,</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>      store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>        type<span class="token operator">:</span> <span class="token string">"TRANSLATE_CANVAS_END"</span><span class="token punctuation">,</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token boolean">false</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>On mouseup, we dispatch a 'TRANSLATE_ITEM_END' or 'TRANSLATE_CANVAS_END' action depending on which was being dragged. Note that these could be combined into a single 'TRANSLATE_END' action since they’re so similar, but we’ll keep them separate for the sake of clarity for now.</p>
<p>Although adding new features with Redux may seem awkward at first, it is very worthwhile because forces you to maintain a separation of concerns. Once you get used to it, it becomes easy to add new features — since everything has an appropriate place, there’s fewer decisions that need to be made from a code design perspective. Although JavaScript is not a purely functional language, we can use functional approaches with Redux to avoiding mutation, which makes the code easier to maintain.</p>


<hr>
<ul><li>Next: <a href="/blog/posts/2017-08-15_Sending-POST-requests-in-Rails-5-1-without-jQuery/">Sending POST requests in Rails 5.1 without jQuery</a></li><li>Previous: <a href="/blog/posts/a-functional-canvas-approach-with-redux-part-1.html">A Functional Canvas Approach With Redux: Part 1</a></li>
</ul>

    </main>

    <footer></footer>

    <!-- Current page: /blog/posts/2017-07-31-a-functional-canvas-approach-with-redux-p2/ -->
  </body>
</html>
